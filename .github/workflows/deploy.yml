name: Blue-Green Deployment

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v3
      
      - name: Conectar a VPS y desplegar
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd ${{ secrets.APP_PATH }}

            # Detectar puerto activo en Nginx
            ACTIVE_PORT=$(grep "server 127.0.0.1" /etc/nginx/sites-available/app.conf | grep -o "300[12]")

            if [ "$ACTIVE_PORT" = "3001" ]; then
              DEPLOY_ENV="green"
              DEPLOY_PORT="3002"
            else
              DEPLOY_ENV="blue"
              DEPLOY_PORT="3001"
            fi

            echo "Entorno activo actual: $ACTIVE_PORT"
            echo "Desplegando en: $DEPLOY_ENV ($DEPLOY_PORT)"

            git fetch origin main
            git reset --hard origin/main

            chmod +x scripts/deploy.sh
            ./scripts/deploy.sh $DEPLOY_ENV

            echo "Esperando al nuevo contenedor..."
            sleep 5

            # Health check
            if curl -s http://127.0.0.1:$DEPLOY_PORT/health > /dev/null; then
              echo "Health check exitoso"

              chmod +x scripts/switch.sh
              ./scripts/switch.sh $DEPLOY_ENV

              echo "Despliegue Blue-Green completado"
            else
              echo "Health check fallido, no se cambiará el tráfico"
              exit 1
            fi
